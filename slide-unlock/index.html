<!doctype html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="原生 JavaScript 实现滑块拖动验证。"><meta name="author" content="Dong WanHong"><title>原生 JavaScript 实现滑块拖动验证</title><link rel="stylesheet" href="https://cdn.bootcss.com/github-markdown-css/3.0.1/github-markdown.min.css"><link rel="shortcut icon" href="/favicon.ico"><link href="/slide-unlock/4.c223c9ff6a346062e759.css" rel="stylesheet"></head><body><header class="header" data-toggle="tab"><button class="button" value="0">示例</button> <button class="button" value="1">文档</button> <button class="button" value="2">源码</button> <a class="button" href="../list">返回</a></header><main role="main"><div class="tab-content"><div class="tab-pane show fade"><div id="slide-wrapper"></div><p><button class="btn button reset">重置</button></p></div><div class="tab-pane markdown-body"><h1 id="原生-javascript-实现滑动拖动验证">原生 JavaScript 实现滑动拖动验证</h1><p>通常，我们在防止用户恶意提交表单的时候，会让用户在提交前完成滑动拖动验证，有时候这也能起到一丝反爬的作用。</p><p>实现滑动验证的方式当然不止一种，这里我们直接使用原生 <code>JavaScript</code> 来实现。</p><h2 id="原生实现">原生实现</h2><p>通过原生 <code>JavaScript</code> 的实现，主要是通过监听鼠标事件来对 DOM 进行一系列的操作。</p><p>滑块验证的结构主要分为四个部分：轨道、滑块、背景和文案，我们可以使用下面的 HTML 结构来表示。</p><pre><code class="hljs html">&lt;<span class="hljs-keyword">div</span> <span class="hljs-built_in">class</span>=<span class="hljs-string">"slide-track"</span>&gt;
  &lt;<span class="hljs-keyword">div</span> <span class="hljs-built_in">class</span>=<span class="hljs-string">"slide-bg"</span>&gt;&lt;/<span class="hljs-keyword">div</span>&gt;
  &lt;<span class="hljs-keyword">div</span> <span class="hljs-built_in">class</span>=<span class="hljs-string">"slide-block"</span>&gt;&lt;/<span class="hljs-keyword">div</span>&gt;
  &lt;p <span class="hljs-built_in">class</span>=<span class="hljs-string">"slide-text"</span>&gt;请按住滑块，拖动到最右边&lt;/p&gt;
&lt;/<span class="hljs-keyword">div</span>&gt;</code></pre><p>基本思路就是我们给滑块（<code>.slide-block</code>）添加相应的事件，在按下滑块时记录鼠标的当前位置并添加滑动事件，在滑动过程中根据鼠标的移动来移动滑块的位置和增加背景元素（<code>.slide-bg</code>）的宽度，直到移动到轨道（<code>.slide-track</code>）的末端后，改变文案（<code>.slide-text</code>）来提示成功。</p><h3 id="样式">样式</h3><p>在开始写脚本之前可以先来完成一下它们的样式，这让滑块相关的部分看起来更好，也让后面的工作更愉快的进行。</p><pre><code class="hljs css"><span class="hljs-comment">/* 样式的注意事项 */</span></code></pre><p>样式的写法就不贴了，相信大家一看就懂，而且会有更好的实现。需要的话，也可以在 Github 上找到。</p><h3 id="脚本">脚本</h3><p>现在开始来实现脚本的内容，首先我们对 <code>document.querySelector</code> 方法进行简单的封装以方便后续操作 DOM 元素。</p><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title">$</span>(selectors) {
  <span class="hljs-keyword">return</span> <span class="hljs-type">document.querySelector(selectors)</span>
}</code></pre><p>然后通过自定义的 <code>_h</code> 函数我们可以很方便的创建上面的 HTML 结构，并添加到文档中。</p><pre><code class="hljs javascript">function _h(tagName, propMap = {}, text) {
  <span class="hljs-keyword">const</span> ele = document.createElement(tagName)
  Object.keys(propMap).forEach(prop =&gt; ele.setAttribute(prop, propMap[prop]))
  <span class="hljs-keyword">if</span> (text) {
    ele.appendChild(document.createTextNode(text))
  }
  <span class="hljs-keyword">return</span> ele
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SlideUnlock</span> </span>{
  <span class="hljs-keyword">constructor</span>(el = <span class="hljs-string">'body'</span>, options = {}) {
    <span class="hljs-keyword">this</span>.$el = $(el)
    <span class="hljs-keyword">this</span>.$isSuccess = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">this</span>.$options = {
      tip: <span class="hljs-string">'请按住滑块，拖动到最右边'</span>,
      unlockText: <span class="hljs-string">'验证成功'</span>,
      duration: <span class="hljs-number">500</span>,
      ...options
    }
  }

  <span class="hljs-keyword">init</span>() {
    <span class="hljs-keyword">this</span>.$root = _h(<span class="hljs-string">'div'</span>, { <span class="hljs-class"><span class="hljs-keyword">class</span>: <span class="hljs-type">'slide-track' }) // 轨道</span></span>
    <span class="hljs-keyword">this</span>.$bg = <span class="hljs-keyword">this</span>.$root.appendChild(_h(<span class="hljs-string">'div'</span>, { <span class="hljs-class"><span class="hljs-keyword">class</span>: <span class="hljs-type">'slide-bg' }))</span></span>
    <span class="hljs-keyword">this</span>.$block = <span class="hljs-keyword">this</span>.$root.appendChild(
      _h(<span class="hljs-string">'div'</span>, { <span class="hljs-class"><span class="hljs-keyword">class</span>: <span class="hljs-type">'slide-block' }) // 滑块</span></span>
    )
    <span class="hljs-keyword">this</span>.$text = <span class="hljs-keyword">this</span>.$root.appendChild(
      _h(<span class="hljs-string">'p'</span>, { <span class="hljs-class"><span class="hljs-keyword">class</span>: <span class="hljs-type">'slide-text' }</span>, <span class="hljs-type">this.$options.tip)</span></span>
    )
    <span class="hljs-keyword">this</span>.$el.insertBefore(<span class="hljs-keyword">this</span>.$root, <span class="hljs-keyword">this</span>.$el.firstChild)
  }
}</code></pre><p>在创建好 DOM 结构后，接下来为滑块添加鼠标按下的事件，在这个事件中我们需要记录下鼠标的初始横坐标，以便后续和滑动过程中的位置相比较，同时为其添加滑动事件。</p><pre><code class="hljs javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SlideUnlock</span> </span>{
  <span class="hljs-keyword">init</span>() {
    <span class="hljs-comment">/* ... */</span>
    <span class="hljs-keyword">this</span>.$block.addEventListener(
      <span class="hljs-string">'mousedown'</span>,
      (<span class="hljs-keyword">this</span>.$handleMouseDown = <span class="hljs-keyword">this</span>._handleMouseDown.bind(<span class="hljs-keyword">this</span>)),
      <span class="hljs-literal">false</span>
    )
  }

  _handleMouseDown(e) {
    <span class="hljs-keyword">const</span> downx = e.clientX

    e.target.addEventListener(
      <span class="hljs-string">'mousemove'</span>,
      (<span class="hljs-keyword">this</span>.$handleMouseMove = <span class="hljs-keyword">this</span>._handleMouseMove.bind(<span class="hljs-keyword">this</span>, downx)),
      <span class="hljs-literal">false</span>
    )
    e.preventDefault()
  }

  _handleMouseMove(downx, e) {}
}</code></pre><p>在这里有点细节需要注意：</p><ul><li>首先，由于事件监听器中的 <code>this</code> 指向的是触发事件的元素，为此我们在指定鼠标按下的监听器时为其绑定了 <code>this</code>，以便调用滑块实例属性和原型上的方法。</li><li>其次，我们在鼠标按下的监听器中添加了鼠标移动的监听器，如果在初始时同按下的监听器一起指定，那么会先执行鼠标移动的监听器，而此时并没有记录鼠标的初始位置；</li></ul><p>接下来我们要实现滑动过程中的主要逻辑：根据鼠标的移动实时地更新滑块的位置，并对一些临界位置进行处理。</p><pre><code class="hljs javascript">_handleMouseMove(downx, e) {
    <span class="hljs-keyword">const</span> info = <span class="hljs-keyword">this</span>.$block.getBoundingClientRect(),
        x = e.clientX,
        y = e.clientY,
        x1 = info.left,
        y1 = info.top,
        x2 = info.right,
        y2 = info.bottom,
        moveX = x - downx

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$isSuccess) {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (moveX &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (x &lt; x1 || x &gt; x2 || y &lt; y1 || y &gt; y2) {
        <span class="hljs-comment">// 当鼠标移开滑块时取消移动</span>
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">this</span>.$block.style.left = `${moveX}px` <span class="hljs-comment">// 更新滑块的我i之</span>
    <span class="hljs-keyword">this</span>.$bg.style.width = `${moveX}px` <span class="hljs-comment">// 同步增大背景元素的宽度</span>

    <span class="hljs-comment">// 当滑块滑动的距离大于等于轨道除去滑块宽度后的距离时表示已经到达轨道的最右边了</span>
    <span class="hljs-keyword">if</span> (moveX &gt;= <span class="hljs-keyword">this</span>.$root.offsetWidth - (x2 - x1)) {
        <span class="hljs-keyword">this</span>.$isSuccess = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">this</span>.$text.textContent = <span class="hljs-string">"验证成功"</span>
        <span class="hljs-keyword">this</span>.$text.style.cssText = `color: #fff; left: <span class="hljs-number">0</span>; right: ${<span class="hljs-keyword">this</span>.$block.offsetWidth}px`
        <span class="hljs-keyword">this</span>.$block.classList.add(<span class="hljs-string">"success"</span>)
    }
}</code></pre><p>这里的实现也很简单，唯一需要看一下的就是通过 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect">getBoundingClientRect</a> 来获取了滑块相对于视口的位置，然后根据鼠标所在的位置来判断鼠标是否在滑块上，如果不在则取消移动。</p><p>现在它已经能很好的滑动，并完成提示成功的基本功能了。但是，当我们每次滑动到中间就取消，然后再次点击滑动时，就会导致重复的添加滑动事件，而且中途释放后，滑块就停在了当前位置，这显然不对。</p><p>解决的办法就是在添加鼠标按下事件的时候，同时也指定一个松开的事件，在这个事件的监听器中判断如果没有成功则取消之前绑定的滑动事件，并进行重置，为了看起来更友好，我们还可以加上一点动画。</p><pre><code class="hljs javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SlideUnlock</span> </span>{
  <span class="hljs-keyword">init</span>() {
    <span class="hljs-comment">/* ... */</span>
    document.addEventListener(
      <span class="hljs-string">'mouseup'</span>,
      (<span class="hljs-keyword">this</span>.$handleMouseUp = <span class="hljs-keyword">this</span>._handleMouseUp.bind(<span class="hljs-keyword">this</span>)),
      <span class="hljs-literal">false</span>
    )
  }

  _handleMouseDown(e) {
    <span class="hljs-comment">/* ... */</span>
    <span class="hljs-comment">// 取消在手动滑动过程中的动画效果</span>
    <span class="hljs-keyword">this</span>.$bg.style.transition = <span class="hljs-string">''</span>
    <span class="hljs-keyword">this</span>.$block.style.transition = <span class="hljs-string">''</span>
    <span class="hljs-comment">/* ... */</span>
  }

  _handleMouseUp(e) {
    <span class="hljs-keyword">this</span>.$block.removeEventListener(<span class="hljs-string">'mousemove'</span>, <span class="hljs-keyword">this</span>.$handleMouseMove, <span class="hljs-literal">false</span>)

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$isSuccess) {
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 给重置过程添加动画效果</span>
    <span class="hljs-keyword">this</span>.$bg.style.transition = <span class="hljs-string">'width 1s ease'</span>
    <span class="hljs-keyword">this</span>.$block.style.transition = <span class="hljs-string">'left 1s ease'</span>

    <span class="hljs-keyword">this</span>.$block.style.left = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>.$bg.style.width = <span class="hljs-number">0</span>
  }
}</code></pre><p>目前为止，滑块已经可以在 PC 端正常的工作了，不过在移动端却并不理想。</p><p>为了它能够在移动端也可以很好的工作，我们可以借助 <code>touchstart</code>、<code>touchmove</code>、<code>touchend</code> 等事件来完成。</p><p>绑定这些事件的时机和处理方式和之前的三个事件分别相对应，所以我们新增两个方法（和 jQuery 的 on、off 方法很像）来更好的添加和移除事件。</p><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bindEvents</span><span class="hljs-params">(events, handler, element = $<span class="hljs-params">(<span class="hljs-string">'body'</span>)</span>)</span> </span>{
  events.split(<span class="hljs-string">' '</span>).<span class="hljs-keyword">forEach</span>(event =&gt; {
    element.addEventListener(event, handler, <span class="hljs-keyword">false</span>)
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unbindEvents</span><span class="hljs-params">(events, handler, element = $<span class="hljs-params">(<span class="hljs-string">'body'</span>)</span>)</span> </span>{
  events.split(<span class="hljs-string">' '</span>).<span class="hljs-keyword">forEach</span>(event =&gt; {
    element.removeEventListener(event, handler, <span class="hljs-keyword">false</span>)
  })
}</code></pre><p>根据这两个方法，我们来稍微修改一下滑块中添加事件的代码。</p><pre><code class="hljs javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SlideUnlock</span> </span>{
  <span class="hljs-keyword">init</span>() {
    <span class="hljs-comment">/* ... */</span>
    bindEvents(
      <span class="hljs-string">'mousedown touchstart'</span>,
      (<span class="hljs-keyword">this</span>.$handleMouseDown = <span class="hljs-keyword">this</span>._handleMouseDown.bind(<span class="hljs-keyword">this</span>)),
      <span class="hljs-keyword">this</span>.$block
    )
    bindEvents(
      <span class="hljs-string">'mouseup touchend'</span>,
      (<span class="hljs-keyword">this</span>.$handleMouseUp = <span class="hljs-keyword">this</span>._handleMouseUp.bind(<span class="hljs-keyword">this</span>)),
      document
    )
  }

  _handleMouseDown(e) {
    <span class="hljs-comment">/* ... */</span>
    <span class="hljs-keyword">if</span> (e.cancelable) {
      e.preventDefault() <span class="hljs-comment">// 阻止默认行为</span>
    }

    <span class="hljs-comment">/* ... */</span>
    bindEvents(
      <span class="hljs-string">'mousemove touchmove'</span>,
      (<span class="hljs-keyword">this</span>.$handleMouseMove = <span class="hljs-keyword">this</span>._handleMouseMove.bind(<span class="hljs-keyword">this</span>, downx)),
      <span class="hljs-keyword">this</span>.$block
    )
  }

  handleMouseUp(e) {
    unbindEvents(<span class="hljs-string">'mousemove touchmove'</span>, <span class="hljs-keyword">this</span>.$handleMouseMove, <span class="hljs-keyword">this</span>.$block)
    <span class="hljs-comment">/* ... */</span>
  }
}</code></pre><p>另外，需要注意的是在移动端 <code>touch</code> 事件中获取 <code>clientX</code>、<code>clientY</code> 时不能在事件对象上直接读取，而是在 <code>event.changedTouches[0]</code> 对象上取得。</p><p>现在，它已经能够同时在 PC 端和移动端上工作了，不过我们还能对它进行一些优化，比如使用函数节流。</p><p>函数节流的实现方式有很多，这里我们列一下在本次中使用的方式。</p><pre><code class="hljs javascript">utils.throttle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, context = {}, delay = 4, <span class="hljs-rest_arg">...outParams</span>)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-rest_arg">...innerParams</span>)</span> </span>{
    clearTimeout(context.$tId)
    context.$tId = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      method.apply(context, [...outParams, ...innerParams])
    }, delay)
  }
}</code></pre><p>然后用这个节流函数，来包装我们移动时的处理函数，并根据实际情况做点调整。</p><p>除此之外，我们还可以添加一个重置的方法，让它回到最初的状态，涉及到的内容也很简单，就是在成功的状态下重新设置样式和绑定事件。</p><pre><code class="hljs javascript">reset() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.$isSuccess) {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">this</span>.$isSuccess = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">this</span>.$bg.style.cssText =
        `transition: width ${<span class="hljs-keyword">this</span>.$options.duration}ms ease; width: <span class="hljs-number">0</span>;`
    <span class="hljs-keyword">this</span>.$block.style.cssText =
        `transition: left ${<span class="hljs-keyword">this</span>.$options.duration}ms ease; left: <span class="hljs-number">0</span>;`
    <span class="hljs-keyword">this</span>.$text.style.cssText =
        `color: #<span class="hljs-number">5f</span>5f5f; left: ${<span class="hljs-keyword">this</span>.$block.offsetWidth}px; right: <span class="hljs-number">0</span>;`
    <span class="hljs-keyword">this</span>.$text.textContent = <span class="hljs-keyword">this</span>.$options.tip
    <span class="hljs-keyword">this</span>.$block.classList.remove(<span class="hljs-string">"success"</span>)
    <span class="hljs-keyword">this</span>._bindEvents()
}</code></pre><p>好了，滑块的实现到这里就告一段落了，相信大家看到这里已经完全明白了，甚至有更好的实现。</p><p>这里写下的实现也只是提供一个思路，欢迎大家一起交流学习。</p><h2 id="如何使用">如何使用</h2><p>你可以简单的在 HTML 页面中引入该脚本，然后根据自己的需求设置合适的样式；不过更好的方式是通过这样的思路，在项目中做一些改进（比如平滑降级）等处理。</p><p>接下来是一个简单的使用模板。</p><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"slide-unlock/core.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
    <span class="hljs-keyword">const</span> slider = <span class="hljs-keyword">new</span> SlideUnlock()
    slider.init()
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></code></pre><p>你可以在 <a href="https://kisstar.github.io/source-code/slide-unlock/">这里</a> 看见完整的使用方式和效果。</p></div><div class="tab-pane"><div class="card" data-toggle="card"><div class="card-title">LESS</div><div class="card-body markdown-body show"><pre><code class="hljs less"><span class="hljs-variable">@track-height:</span> <span class="hljs-number">32px</span>;
<span class="hljs-variable">@block-width:</span> <span class="hljs-number">45px</span>;
<span class="hljs-variable">@slide-pc-size:</span> <span class="hljs-number">18px</span>;

<span class="hljs-variable">@block-text:</span> <span class="hljs-number">#afafaf</span>;
<span class="hljs-variable">@block-pc-text:</span> <span class="hljs-number">#fff</span>;
<span class="hljs-variable">@slide-text:</span> <span class="hljs-number">#5f5f5f</span>;

<span class="hljs-variable">@track-bg:</span> <span class="hljs-number">#e8e8e8</span>;
<span class="hljs-variable">@block-bg:</span> <span class="hljs-number">#fff</span>;
<span class="hljs-variable">@block-bd:</span> <span class="hljs-number">#ccc</span>;
<span class="hljs-variable">@bg-success:</span> <span class="hljs-number">#7cc13c</span>;

<span class="hljs-selector-class">.slide-track</span> {
  <span class="hljs-selector-tag">&amp;</span>,
  * {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">box-sizing</span>: border-box;
  }

  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-variable">@track-height</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-variable">@track-bg</span>;

  <span class="hljs-selector-class">.slide-block</span> {
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">999</span>;
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-variable">@block-width</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-variable">@track-height</span>;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-variable">@track-height</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">color</span>: <span class="hljs-variable">@block-text</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-variable">@block-bg</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-variable">@block-bd</span>;
    <span class="hljs-attribute">cursor</span>: move;

    <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-pseudo">::after</span> {
      <span class="hljs-attribute">content</span>: <span class="hljs-string">'»'</span>;
    }

    <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-class">.success</span><span class="hljs-selector-pseudo">::after</span> {
      <span class="hljs-attribute">content</span>: <span class="hljs-string">'√'</span>;
      <span class="hljs-attribute">display</span>: block;
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
      <span class="hljs-attribute">transform</span>: translate(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
      <span class="hljs-attribute">width</span>: <span class="hljs-variable">@slide-pc-size</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-variable">@slide-pc-size</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-variable">@slide-pc-size</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-variable">@block-pc-text</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-variable">@bg-success</span>;
    }
  }

  <span class="hljs-selector-class">.slide-text</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">left</span>: <span class="hljs-variable">@block-width</span>;
    <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">99</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-variable">@track-height</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">color</span>: <span class="hljs-variable">@slide-text</span>;
  }

  <span class="hljs-selector-class">.slide-bg</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-variable">@block-width</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-variable">@bg-success</span>;
  }
}
</code></pre></div></div><div class="card" data-toggle="card"><div class="card-title">JavaScript</div><div class="card-body markdown-body"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> utils = new (<span class="hljs-class"><span class="hljs-keyword">class</span> </span>{
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@public</span>
   * <span class="hljs-doctag">@method</span>
   * <span class="hljs-doctag">@name</span> isFunction
   * <span class="hljs-doctag">@description</span> 判断传入的值是否是一个函数
   * <span class="hljs-doctag">@param</span> {*} value 需要检测的值
   * <span class="hljs-doctag">@returns</span> {boolean}
   */</span>
  isFunction(value) {
    <span class="hljs-keyword">return</span> Object.prototype.toString.call(value) === <span class="hljs-string">'[object Function]'</span>
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@public</span>
   * <span class="hljs-doctag">@function</span>
   * <span class="hljs-doctag">@name</span> $
   * <span class="hljs-doctag">@description</span> 获取文档中与指定选择器或选择器组匹配的第一个 HTML 元素
   * <span class="hljs-doctag">@param</span> {string} selectors 包含一个或多个要匹配的选择器的 DOM 字符串
   * <span class="hljs-doctag">@returns</span> {Element | null} 如果找不到匹配项，则返回 null，否则返回对应的 Element
   */</span>
  $(selectors) {
    <span class="hljs-keyword">return</span> document.querySelector(selectors)
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@private</span>
   * <span class="hljs-doctag">@method</span>
   * <span class="hljs-doctag">@name</span> _h
   * <span class="hljs-doctag">@description</span> 创建由 tagName 指定的 HTML 元素
   * <span class="hljs-doctag">@param</span> {string} tagName 指定要创建元素类型的字符串
   * <span class="hljs-doctag">@param</span> {object} propMap 可选的，包含 class 等额外配置项
   * <span class="hljs-doctag">@param</span> {string} text 可选的文字节点
   * <span class="hljs-doctag">@returns</span> {Element | HTMLUnknownElement} 如果 tagName 不被识别，则创建一个 HTMLUnknownElement
   */</span>
  h(tagName, propMap = {}, text) {
    <span class="hljs-keyword">const</span> ele = document.createElement(tagName)
    Object.keys(propMap).forEach(prop =&gt; ele.setAttribute(prop, propMap[prop]))
    <span class="hljs-keyword">if</span> (text) {
      ele.appendChild(document.createTextNode(text))
    }
    <span class="hljs-keyword">return</span> ele
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@public</span>
   * <span class="hljs-doctag">@function</span>
   * <span class="hljs-doctag">@name</span> bindEvents
   * <span class="hljs-doctag">@param</span> {string} events 一个以空格分开的字符串，指定了要绑定的事件
   * <span class="hljs-doctag">@param</span> {function} handler 事件监听器
   * <span class="hljs-doctag">@param</span> {Element | undefined} element 可选的，绑定事件的元素
   * <span class="hljs-doctag">@returns</span> {void}
   */</span>
  bindEvents(events, handler, element = <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'body'</span>)) {
    events.split(<span class="hljs-string">' '</span>).forEach(event =&gt; {
      element.addEventListener(event, handler, <span class="hljs-literal">false</span>)
    })
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@public</span>
   * <span class="hljs-doctag">@function</span>
   * <span class="hljs-doctag">@name</span> unbindEvents
   * <span class="hljs-doctag">@param</span> {string} events 一个以空格分开的字符串，指定了要取消的事件
   * <span class="hljs-doctag">@param</span> {function} handler 事件监听器
   * <span class="hljs-doctag">@param</span> {Element | undefined} element 可选的，取消事件的元素
   * <span class="hljs-doctag">@returns</span> {void}
   */</span>
  unbindEvents(events, handler, element = <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'body'</span>)) {
    events.split(<span class="hljs-string">' '</span>).forEach(event =&gt; {
      element.removeEventListener(event, handler, <span class="hljs-literal">false</span>)
    })
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@public</span>
   * <span class="hljs-doctag">@function</span>
   * <span class="hljs-doctag">@name</span> throttle
   * <span class="hljs-doctag">@description</span> 对函数进行包装，避免高频率执行损耗性能
   * <span class="hljs-doctag">@param</span> {function} method 需要执行函数
   * <span class="hljs-doctag">@param</span> {object} context 函数执行时的上下文环境
   * <span class="hljs-doctag">@param</span> {number} delay 时间，以毫秒计
   * <span class="hljs-doctag">@returns</span> {function} 包装后的函数
   */</span>
  throttle(method, context = {}, delay = <span class="hljs-number">4</span>, ...outParams) {
    function withThtottle(...innerParams) {
      clearTimeout(context.$$tId)
      function throttleCore() {
        method.apply(context, [...outParams, ...innerParams])
      }
      throttleCore.displayName = `throttleCore(${method.name})`
      <span class="hljs-comment">// eslint-disable-next-line no-param-reassign</span>
      context.$$tId = setTimeout(throttleCore, delay)
    }
    withThtottle.displayName = `withThtottle(${method.name})`
    <span class="hljs-keyword">return</span> withThtottle
  }
})()

<span class="hljs-comment">/**
 * Class implement slide verification.
 * <span class="hljs-doctag">@example</span>
 * new SlideUnlock().init()
 */</span>
<span class="hljs-comment">// eslint-disable-next-line no-unused-vars</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SlideUnlock</span> </span>{
  <span class="hljs-comment">/**
   * 初始化滑块，处理配置
   * <span class="hljs-doctag">@param</span> {Element} el 挂载的元素
   * <span class="hljs-doctag">@param</span> {object} options 配置项
   */</span>
  <span class="hljs-keyword">constructor</span>(el = <span class="hljs-string">'body'</span>, options = {}) {
    <span class="hljs-keyword">this</span>.$el = utils.$(el)
    <span class="hljs-keyword">this</span>.$$isSuccess = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">this</span>.$options = {
      tip: <span class="hljs-string">'请按住滑块，拖动到最右边'</span>,
      unlockText: <span class="hljs-string">'验证成功'</span>,
      duration: <span class="hljs-number">500</span>,
      ...options
    }
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@public</span>
   * <span class="hljs-doctag">@method</span>
   * <span class="hljs-doctag">@name</span> init
   * <span class="hljs-doctag">@description</span> 创建滑块的 DOM 结构，并添加鼠标在滑块上按下的监听器
   * <span class="hljs-doctag">@returns</span> {void}
   */</span>
  <span class="hljs-keyword">init</span>() {
    <span class="hljs-keyword">this</span>.$$root = utils.h(<span class="hljs-string">'div'</span>, { <span class="hljs-class"><span class="hljs-keyword">class</span>: <span class="hljs-type">'slide-track' })</span></span>
    <span class="hljs-keyword">this</span>.$$bg = <span class="hljs-keyword">this</span>.$$root.appendChild(utils.h(<span class="hljs-string">'div'</span>, { <span class="hljs-class"><span class="hljs-keyword">class</span>: <span class="hljs-type">'slide-bg' }))</span></span>
    <span class="hljs-keyword">this</span>.$$block = <span class="hljs-keyword">this</span>.$$root.appendChild(
      utils.h(<span class="hljs-string">'div'</span>, { <span class="hljs-class"><span class="hljs-keyword">class</span>: <span class="hljs-type">'slide-block' })</span></span>
    )
    <span class="hljs-keyword">this</span>.$$text = <span class="hljs-keyword">this</span>.$$root.appendChild(
      utils.h(<span class="hljs-string">'p'</span>, { <span class="hljs-class"><span class="hljs-keyword">class</span>: <span class="hljs-type">'slide-text' }</span>, <span class="hljs-type">this.$options.tip)</span></span>
    )
    <span class="hljs-keyword">this</span>.$el.insertBefore(<span class="hljs-keyword">this</span>.$$root, <span class="hljs-keyword">this</span>.$el.firstChild)
    <span class="hljs-keyword">this</span>._bindEvents()
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@private</span>
   * <span class="hljs-doctag">@method</span>
   * <span class="hljs-doctag">@name</span> _bindEvents
   * <span class="hljs-doctag">@description</span> 绑定鼠标的按下和松开事件
   * <span class="hljs-doctag">@returns</span> {void}
   */</span>
  _bindEvents() {
    utils.bindEvents(
      <span class="hljs-string">'mousedown touchstart'</span>,
      (<span class="hljs-keyword">this</span>.$$handleMouseDown = <span class="hljs-keyword">this</span>._handleMouseDown.bind(<span class="hljs-keyword">this</span>)),
      <span class="hljs-keyword">this</span>.$$block
    )
    utils.bindEvents(
      <span class="hljs-string">'mouseup touchend'</span>,
      (<span class="hljs-keyword">this</span>.$$handleMouseUp = <span class="hljs-keyword">this</span>._handleMouseUp.bind(<span class="hljs-keyword">this</span>)),
      document
    )
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@private</span>
   * <span class="hljs-doctag">@method</span>
   * <span class="hljs-doctag">@name</span> _handleMouseDown
   * <span class="hljs-doctag">@description</span> 滑块上鼠标按下的监听器，主要记录鼠标的横坐标并指定滑块滑动的监听器
   * <span class="hljs-doctag">@param</span> {MouseEvent} e 一个基于 Event 的对象
   * <span class="hljs-doctag">@returns</span> {void}
   */</span>
  _handleMouseDown(e) {
    <span class="hljs-keyword">const</span> eve = e || window.e
    <span class="hljs-keyword">const</span> downx = eve.clientX || e.changedTouches[<span class="hljs-number">0</span>].clientX

    <span class="hljs-keyword">if</span> (e.cancelable) {
      e.preventDefault() <span class="hljs-comment">// 阻止默认行为</span>
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$$isSuccess) {
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 取消在手动滑动过程中的动画效果</span>
    <span class="hljs-keyword">this</span>.$$bg.style.transition = <span class="hljs-string">''</span>
    <span class="hljs-keyword">this</span>.$$block.style.transition = <span class="hljs-string">''</span>

    utils.bindEvents(
      <span class="hljs-string">'mousemove touchmove'</span>,
      (<span class="hljs-keyword">this</span>.$$handleMouseMove = utils.throttle(
        <span class="hljs-keyword">this</span>._handleMouseMove,
        <span class="hljs-keyword">this</span>,
        undefined,
        downx
      )),
      <span class="hljs-keyword">this</span>.$$block
    )
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@private</span>
   * <span class="hljs-doctag">@method</span>
   * <span class="hljs-doctag">@name</span> _handleMouseMove
   * <span class="hljs-doctag">@description</span> 滑块滑动的监听器，主要更新滑块位置和背景元素的宽度
   * <span class="hljs-doctag">@param</span> {MouseEvent} e 一个基于 Event 的对象
   * <span class="hljs-doctag">@returns</span> {void}
   */</span>
  _handleMouseMove(downx, e) {
    <span class="hljs-keyword">const</span> info = <span class="hljs-keyword">this</span>.$$block.getBoundingClientRect()
    <span class="hljs-keyword">const</span> x = e.clientX || e.changedTouches[<span class="hljs-number">0</span>].clientX
    <span class="hljs-keyword">const</span> y = e.clientY
    <span class="hljs-keyword">const</span> x1 = info.left
    <span class="hljs-keyword">const</span> y1 = info.top
    <span class="hljs-keyword">const</span> x2 = info.right
    <span class="hljs-keyword">const</span> y2 = info.bottom
    <span class="hljs-keyword">const</span> moveX = x - downx

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$$isSuccess) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (moveX &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (x &lt; x1 || x &gt; x2 || y &lt; y1 || y &gt; y2) {
      <span class="hljs-comment">// 当鼠标移开滑块时取消移动</span>
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">this</span>.$$block.style.left = `${moveX}px`
    <span class="hljs-keyword">this</span>.$$bg.style.width = `${moveX}px`

    <span class="hljs-keyword">if</span> (moveX &gt;= <span class="hljs-keyword">this</span>.$$root.offsetWidth + x1 - x2) {
      <span class="hljs-keyword">this</span>.$$isSuccess = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.$$text.textContent = <span class="hljs-keyword">this</span>.$options.unlockText
      <span class="hljs-keyword">this</span>.$$text.style.cssText = `color: #fff; left: <span class="hljs-number">0</span>; right: ${<span class="hljs-keyword">this</span>.$$block.offsetWidth}px;`
      <span class="hljs-keyword">this</span>.$$block.classList.add(<span class="hljs-string">'success'</span>)
      <span class="hljs-keyword">if</span> (utils.isFunction(<span class="hljs-keyword">this</span>.$options.cb)) {
        <span class="hljs-comment">// 为了避免阻塞成功提示界面的渲染，你可以设置两百毫秒左右的延迟</span>
        <span class="hljs-keyword">this</span>.$options.cb.call(<span class="hljs-keyword">this</span>)
      }
    }
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@private</span>
   * <span class="hljs-doctag">@method</span>
   * <span class="hljs-doctag">@name</span> _handleMouseUp
   * <span class="hljs-doctag">@description</span> 鼠标松开的监听器，主要用于重置
   * <span class="hljs-doctag">@param</span> {MouseEvent} e 一个基于 Event 的对象
   * <span class="hljs-doctag">@returns</span> {void}
   */</span>
  _handleMouseUp() {
    clearTimeout(<span class="hljs-keyword">this</span>.$$tId)
    utils.unbindEvents(
      <span class="hljs-string">'mousemove touchmove'</span>,
      <span class="hljs-keyword">this</span>.$$handleMouseMove,
      <span class="hljs-keyword">this</span>.$$block
    )

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$$isSuccess) {
      utils.unbindEvents(<span class="hljs-string">'mouseup touchend'</span>, <span class="hljs-keyword">this</span>.$$handleMouseUp, document)
      utils.unbindEvents(
        <span class="hljs-string">'mousedown touchstart'</span>,
        <span class="hljs-keyword">this</span>.$$handleMouseDown,
        <span class="hljs-keyword">this</span>.$$block
      )
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 给重置过程添加动画效果</span>
    <span class="hljs-keyword">this</span>.$$bg.style.cssText = `transition: width ${<span class="hljs-keyword">this</span>.$options.duration}ms ease; width: <span class="hljs-number">0</span>;`
    <span class="hljs-keyword">this</span>.$$block.style.cssText = `transition: left ${<span class="hljs-keyword">this</span>.$options.duration}ms ease; left: <span class="hljs-number">0</span>;`
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@public</span>
   * <span class="hljs-doctag">@method</span>
   * <span class="hljs-doctag">@name</span> isSuccess
   * <span class="hljs-doctag">@description</span> 返回当前滑块的状态
   * <span class="hljs-doctag">@returns</span> {boolean}
   */</span>
  isSuccess() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.$$isSuccess
  }

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@public</span>
   * <span class="hljs-doctag">@method</span>
   * <span class="hljs-doctag">@name</span> reset
   * <span class="hljs-doctag">@description</span> 重置滑块的状态
   * <span class="hljs-doctag">@returns</span> {void}
   */</span>
  reset() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.$$isSuccess) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">this</span>.$$isSuccess = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">this</span>.$$bg.style.cssText = `transition: width ${<span class="hljs-keyword">this</span>.$options.duration}ms ease; width: <span class="hljs-number">0</span>;`
    <span class="hljs-keyword">this</span>.$$block.style.cssText = `transition: left ${<span class="hljs-keyword">this</span>.$options.duration}ms ease; left: <span class="hljs-number">0</span>;`
    <span class="hljs-keyword">this</span>.$$text.style.cssText = `color: #<span class="hljs-number">5f</span>5f5f; left: ${<span class="hljs-keyword">this</span>.$$block.offsetWidth}px; right: <span class="hljs-number">0</span>;`
    <span class="hljs-keyword">this</span>.$$text.textContent = <span class="hljs-keyword">this</span>.$options.tip
    <span class="hljs-keyword">this</span>.$$block.classList.remove(<span class="hljs-string">'success'</span>)
    <span class="hljs-keyword">this</span>._bindEvents()
  }
}
</code></pre></div></div></div></div></main><footer class="footer"><a href="https://github.com/kisstar/source-code/"><span class="gh-icon"></span> <span>Star (^▽^ ) or Fork me on GitHub</span></a></footer><script src="/runtime/main.15d0a0e3.js"></script><script src="/common/common.da1a0dc5.min.js"></script><script src="/slide-unlock/slide-unlock.8a641c42.min.js"></script></body></html>